<html lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"> 
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="The easiest way to save and share passwords. Remember and share everything from web accounts, credit cards, 2-factor backup codes, security question answers, and WiFi passwords.">
    <title>Mitro: Password Importer</title>

    <!--[if lte IE 8]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.css" /> -->
    <link href="../less/main-org.css" rel="stylesheet" media="screen">
  </head>
  <body>
    <div id="container">
      <div id="header"></div>
      <div id="wrapper">
        <div id="sidebar">
          <div class="sb-section" id="profile">
            <a href="https://www.mitro.co" class="icon-logo"></a>
            <div id="username">username</div>
          </div>
          <div class="sb-section" id="acct-nav">
            <ul>
              <li>
                <div class="acct-name">
                  <div class="nav-icon icon-user"></div><a href="index.html">Personal</a>
                </div>
                <ul class="acct-info">
                    <li><a class="acct-secrets" href="index.html"><div class="nav-icon icon-vault"></div>Secrets</a></li>
                    <li><a class="acct-teams" href="personal-teams.html"><div class="nav-icon icon-vault2"></div>Teams</a></li>
                    <li><a class="acct-logs" href="personal-logs.html"><div class="nav-icon icon-bars"></div>Audit Logs</a></li>
                </ul>
              </li>
              <li>
                <div class="acct-name">
                  <div class="org-icon" style="background-color: yellowgreen;"></div><div class="nav-icon icon-users"></div><a href="index-org.html">Lectorius <span class="admin-tag">Admin<span></a>
                </div>
                <ul class="acct-info">
                    <li><a class="acct-home" href="index-org.html"><div class="nav-icon icon-home"></div>Overview</a></li>
                    <li><a class="acct-secrets" href="org-secrets.html"><div class="nav-icon icon-vault"></div>Secrets</a></li>
                    <li><a class="acct-members" href="org-members.html"><div class="nav-icon icon-usercircle"></div>Members</a></li>
                    <li><a class="acct-teams" href="org-teams.html"><div class="nav-icon icon-vault2"></div>Teams</a></li>
                    <li><a class="acct-logs" href="org-logs.html"><div class="nav-icon icon-bars"></div>Audit Logs</a></li>
                </ul>
              </li>
              <li>
                <div class="acct-name">
                  <div class="org-icon" style="background-color: pink;"></div><div class="nav-icon icon-users"></div><a href="main-org-user.html">Essence Digital</a>
                </div>
                <ul class="acct-info">
                    <li><a class="acct-secrets" href="main-org-user.html"><div class="nav-icon icon-vault"></div>Secrets</a></li>
                    <li><a class="acct-teams" href="org-user-teams.html"><div class="nav-icon icon-vault2"></div>Teams</a></li>
                </ul>
              </li>
              <li>
                <div class="acct-name">
                  <div class="nav-icon icon-users"></div>Stack Exchange
                </div>
                <ul class="acct-info">
                    <li><a class="acct-secrets" href="main-org-user.html"><div class="nav-icon icon-vault"></div>Secrets</a></li>
                    <li><a class="acct-teams" href="org-user-teams.html"><div class="nav-icon icon-vault2"></div>Teams</a></li>
                </ul>
              </li>
            </ul>
          </div>
          <div class="sb-section" id="tool-nav">
            <ul>
              <li class="selected"><a href="import-secrets.html"><div class="nav-icon icon-download"></div>Import Secrets</a></li>
              <!--<li><div class="nav-icon icon-wrench"></div>Tools</li>-->
              <!--<li><a href="settings.html"><div class="nav-icon icon-gear"></div>Settings</a></li>-->
              <li><a href="feedback-form.html"><div class="nav-icon icon-bubble"></div>Feedback</a></li>
              <li><a href="mailto:inbound@mitro.co"><div class="nav-icon icon-question"></div>Help</a></li>
              <li><div class="nav-icon icon-switch"></div>Sign Out</li>
            </ul>
          </div>
          <div class="sb-section" id="policy-nav">
            <ul>
              <li><a href="privacy.html">Privacy Policy</a></li>
              <li><a href="terms.html">Terms of Service</a></li>
            </ul>
          </div>
        </div>
        <div id="content">
          <div id="content-header">
            <ul class="breadcrumb">
              <li><div class="nav-icon icon-download"></div>Import Secrets</li>
            </ul>
          </div>
          <div id="content-body">
            <div id="import-secrets">
              <div id="import-options">
                <h3>Select the password manager from which you wish to import from</h3>
                <button class="import-btn" data-import-source="lastpass">LastPass</button>
                <button class="import-btn" data-import-source="keepass">KeePass</button>
                <button class="import-btn" data-import-source="roboform">Roboform</button>
                <button class="import-btn" data-import-source="passpack">Passpack</button>
              </div>
              <form id="import-form" data-id="">
                <ul class="breadcrumb">
                  <li><div class="nav-icon icon-undo"></div><a id="back-to-import-options" href="#">Back to import options</a></li>
                  <li><span id="password-manager-name"></span> Importer</li>
                </ul>

                <div class="import-instructions" id="lastpass">
                  <p>Export your LastPass database to a CSV file and then upload it to select which secrets you wish to upload to Mitro.</p>
                  <ul>
                  <li>Click the LastPass button next to the URL bar.</li>
                  <li>From the menu, choose Tools → Advanced Tools → Export To → LastPass CSV File.</li>
                  <li>When it shows all your passwords, from the browser's menu choose Edit → Select All then Edit → Copy.</li>
                  <li>Open a text editing program, paste into a new document, and save it somewhere.</li>
                  <li>Upload the .csv file using this form.</li>
                  </ul>
                </div>

                <div class="import-instructions" id="keepass">
                  <p>Export your KeePass database to an XML file and then upload it to select which secrets you wish to upload to Mitro.</p>
                  <ul>
                    <li>Export KeePass database to XML file</li>
                    <li>Select XML file to upload with form below</li>
                    <li>Select team to save the selected secrets to</li>
                    <li>Click 'Add to Mitro' to import the selected passwords</li>
                  </ul>
                </div>

                <div class="import-instructions" id="roboform">
                  <p>Export your Roboform database to an HTML file and then upload it to select which secrets you wish to upload to Mitro.</p>
                </div>

                <div class="import-instructions" id="passpack">
                  <p>Export your Passpack database to a CSV file and then upload it to select which secrets you wish to upload to Mitro.</p>
                  <ul>
                    <li>Log into Passpack</li>
                    <li>Select 'Tools'</li>
                    <li>Select 'Export'</li>
                    <li>Select the 'Comma Separated Values' format</li>
                    <li>Save the output to a CSV file</li>
                    <li><strong>Be sure to NOT change the order in which password data is displayed.</strong></li>
                    <li>Select CSV file to upload with form below</li>
                    <li>Click 'Add to Mitro' to import the selected passwords</li>
                  </ul>
                </div>

                <input type="file" id="files" name="files[]" single />

                <div id="password-list">
                  <button id="toggle-checked" class="button-sm" data-target-id="password-import-table">Select/Unselect All</button>
                  <table id="password-import-table" class="tablesorter">
                    <thead>
                      <tr>
                        <th id="password-import">Import</th>
                        <th id="password-title">Title</th>
                        <th id="password-user">Username</th>
                        <th id="password-url">Login URL</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td>
                          <input id="0" type="checkbox">
                        </td>
                        <td>Another Secret</td>
                        <td>usertest77</td>
                        <td>http://www.wwwwwwerwieofjawefsdfjwefadfwefiasfkawefsf.com</td>
                      </tr>
                      <tr>
                        <td>
                          <input id="1" type="checkbox" checked>
                        </td>
                        <td>test secret</td>
                        <td></td>
                        <td></td>
                      </tr>
                      <tr>
                        <td>
                          <input id="0" type="checkbox">
                        </td>
                        <td>Another Secret</td>
                        <td>usertest77</td>
                        <td>http://www.wwwwwwerwieofjawefsdfjwefadfwefiasfkawefsf.com</td>
                      </tr>
                      <tr>
                        <td>
                          <input id="0" type="checkbox">
                        </td>
                        <td>Another Secret</td>
                        <td>usertest77</td>
                        <td>http://www.wwwwwwerwieofjawefsdfjwefadfwefiasfkawefsf.com</td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <div class="form-group" id="import-destination-group">
                  <!--Not for roboform or passpack?-->
                  <label>Select team to save secrets to: </label>
                  <select id="group-select">
                      <option value="">TEST</option>
                  </select>
                </div>

                <button id="add-to-mitro-button" class="button-med"><div class="icon-plus"></div>Add to Mitro</button>

                <div id="upload-progress">
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>-->
    <script src="../js/jquery.min.js"></script>
    <script src="../js/jquery-ui.min.js"></script>
    <script src="../js/mustache.js"></script>
    <script>
      $(function() {
         // Process the password manager selection
         $('.import-btn').click(function() {
          var selectedManager = $(this).data('import-source');
          var selectedManagerName = $(this).html(); // The button value == the password manager name
          if (selectedManager) {
            switch(selectedManager) {
              case 'lastpass':
              case 'keepass':
              case 'roboform':
              case 'passpack':
                $('#import-form').attr('data-id', selectedManager); // set the data id for the form to the password manager
                $('#password-manager-name').html(selectedManagerName);
                $('#import-form').show(); // show the form
                $('#import-options').hide(); // hide the selection area
                setFileSelectHandler(selectedManager); // set the file select event handler
                break;
              default:
                alert('Sorry, that password manager is not valid.');
                break;
            }
          }
         });

         $('#back-to-import-options').click(function(e) {
            e.preventDefault();
            $('#import-form').hide(); // hide the form and all the instructions
            $('#import-options').show(); // show the selection area
         });

         function setFileSelectHandler(passwordManager) {
            if (passwordManager) {
              switch(passwordManager) {
                case 'lastpass':
                  var importer = new LastpassImporter();
                  break;
                case 'keepass':
                  var importer = new KeepassImporter();
                  break;
                case 'roboform':
                  var importer = new RoboformImporter();
                  break;
                case 'passpack':
                  var importer = new PasspackImporter();
                  break;
              }
              mitro.importer.attachEventHandlers(importer.handleFileSelect);
            }
         }

        $('#toggle-checked').click(function(e) {
          e.preventDefault();
          var targetID = $(this).data('target-id');
          var $targetEl = $('#' + targetID);
          var checkboxes = $targetEl.find('input[type=checkbox]');
          checkboxes.prop('checked', !checkboxes.prop('checked'));
        });
      });

      /* Parent Class for the Password Manager Importers */
      /* All share same handleFileSelect function, with individually defined parseFile functions */
      /* fileType should be defined by subclasses - csv, html, xml, etc. */
      function Importer(fileType, parseFn) { // should not be able to call this directly
        this.fileType = fileType || '';
        var parseFile = parseFn || function(){};
      }

      Importer.prototype.handleFileSelect = function(evt) {
        var files = evt.target.files;
        var f = files[0];
        var reader = new FileReader();
        if (!f.name.match('.' + fileType)) {
          alert('Currently the tool only supports ' + this.fileType + ' uploads.');
          throw new Error('Unsupported file type');
        }

        reader.onload = (function (theFile) {
          return function (e) {
            var exportedFile = e.target.result;
            appendPasswordsToPage(parseFile.call(this, exportedFile));
          };
        })(f);

        reader.readAsText(f, 'UTF-8');
        $("#password-list").html("");
        $('#upload-progress').empty();
        passwords = [];
      };

      function KeepassImporter() {
        Importer.call(this, 'xml', parseXML);

        /*var parseFile = function(exportedFile) {
          parseXML(exportedFile);
        };*/

        function parseXML(xmlKeepassExport) {
          $("#password-list").empty();
          var $xml = $($.parseXML(xmlKeepassExport));
          var passwords = parseKeepassVersion2x($xml);
          if (passwords.length !== 0) {
            return passwords;
          }

          passwords = parseKeepassVersion1x($xml);
          return passwords;
        };

        // I'm not sure what format this is? KeePass 2.x?
        function parseKeepassVersion2x($xml) {
          var values = [];
          var keys = [];

          //Creates two arrays of corresponding values - one for xml keys and one for the values of the keys
          $("Entry", $xml).each(function () {
            var entries = [];
            $("Key", this).each(function() {
              entries.push(this.textContent);
            });
            keys.push(entries);
          });

          $("Entry", $xml).each(function () {
            var entries = [];
            $("Value", this).each(function() {
              entries.push(this.textContent);
            });
            values.push(entries);
          });

          var passwords = [];
          for (var i = 0; i < values.length; i++) {
            var username = values[i][keys[i].indexOf("UserName")];
            var password = values[i][keys[i].indexOf("Password")];
            var loginurl = values[i][keys[i].indexOf("URL")];
            var title = values[i][keys[i].indexOf("Title")];
            // TODO: extract keepass note
            var comment = '';

            passwords.push(new Password(username, password, loginurl, title, comment));
          }
          return passwords;
        };

        // KeePass 1.x from http://keepass.info/help/base/importexport.html#xml
        // This also parses KeePassX 0.4.3, even though they look quite different
        var parseKeepassVersion1x = function ($xml) {
          var passwords = [];
          $("pwentry,entry", $xml).each(function (index, element) {
            var username = $("username", element).text();
            var password = $("password", element).text();
            var title = $("title", element).text();
            var url = $("url", element).text();
            // TODO: extract keepass note
            var comment = '';

            passwords.push(new Password(username, password, url, title, comment));
          });

          return passwords;
        }
      }

      KeepassImporter.prototype = new Importer();
      KeepassImporter.prototype.constructor = KeepassImporter;

      function PasspackImporter() {
        /*var parseFile = function(exportedFile) {
          parseCSV(exportedFile);
        };*/

        Importer.call(this, 'csv', parseCSV);

        function parseCSV(csv){
          if (csv !== ""){
            csv = mitro.importer.convertLineEndingsToUnix(csv);
            var passwordsArray = $.csv.toArrays(csv);

            for (var i = 0; i < passwordsArray.length; i++) {
              var passwordArray = passwordsArray[i];

              var title = passwordArray[0];
              var username = passwordArray[1];
              var password = passwordArray[2];
              var loginUrl = passwordArray[3];
              // TODO: extract passpack note
              var comment = '';

              // TODO: Don't reference this global variable!
              passwords.push(new Password(username, password, loginUrl, title, comment));
            }
          }
          return passwords;
        }
      }

      PasspackImporter.prototype = new Importer();
      PasspackImporter.prototype.constructor = PasspackImporter;

      function LastpassImporter() {
        /*var parseFile = function(exportedFile) {
          parseCSV(exportedFile);
        };*/

        Importer.call(this, 'csv', parseCSV);

        function parseCSV(csv) {
          try {
            $("#password-list").empty();

            csvText = mitro.importer.convertLineEndingsToUnix(csvText);
            var objects = $.csv.toObjects(csvText);
            var rval = [];
            for (var i = 0; i < objects.length; ++i) {
              var title = objects[i].name;
              if (objects[i].grouping) {
                title += ' [' + objects[i].grouping + ']';
              }
              if (!objects[i].password) {
                continue;
              }
              passwords.push(new Password(objects[i].username, objects[i].password, objects[i].url, title, objects[i].extra));
            }
            return passwords;
          } catch (e) {
            console.log(e);
            console.log(e.stack);
            showErrorDialog(e);
          }
        }
      }

      LastpassImporter.prototype = new Importer();
      LastpassImporter.prototype.constructor = LastpassImporter;

      function RoboformImporter() {

        Importer.call(this, 'csv', parseHtml);

        var uploadedHtml;

        /*var parseFile = function(exportedFile) {
          parseHTML(exportedFile);
        };*/

        function parseHtml(html) {
          var roboformEntries = [];
          var titles = findLoginDataInRoboformTable(html,'caption');
          var loginUrls = findLoginDataInRoboformTable(html,'subcaption');
          var roboformPasswords = [];
          var usernames = [];
          var roboformSecretData = findLoginDataInRoboformTable(html,'wordbreakfield');
          var loginUrlsHtml = findLoginDataHtmlString(html,'subcaption');
          var i;
          for (i = 0; i < loginUrls.length; i++){
            var usernameHtml = $(loginUrlsHtml[i].parent().next().html());
            var passwordHtml = $(loginUrlsHtml[i].parent().next().next().html());
            usernames.push($(usernameHtml[usernameHtml.length-1]).text());
            roboformPasswords.push($(passwordHtml[passwordHtml.length-1]).text());
          }

          titles = cleanArray(titles);
          loginUrls = cleanArray(loginUrls);
          roboformPasswords = cleanArray(roboformPasswords);
          usernames = cleanArray(usernames);

          for (i = 0; i < titles.length; ++i) {
            var username = usernames[i];
            var password = roboformPasswords[i];
            var loginUrl = loginUrls[i];
            var title = titles[i];
            // TODO: extract roboform note
            var comment = '';
            
            passwords.push(new Password(username,password,loginUrl,title, comment));
          }
          return passwords;
        }

        function cleanArray(array){
          var rval = [];

          for(var i = 0;i<array.length;i++){
            if(array[i] !== undefined){
                rval.push(array[i]);
            }
          }
          return rval;
        }

        function findLoginDataInRoboformTable(html,className){
          var rval = [];
          uploadedHtml = html;

          $.each($(html).find('.' + className),function(index,value){
            rval.push($(value).text());
          });
          return rval;
        }

        function findLoginDataHtmlString(html,className){
            var rval = [];
            uploadedHtml = html;

            $.each($(html).find('.' + className),function(index,value){
              rval.push($(value));
          });
          return rval;
        }
      }

      RoboformImporter.prototype = new Importer();
      RoboformImporter.prototype.constructor = RoboformImporter;

    </script>
  </body>
</html>